name: 360T7 固件全量分区提取

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: '请输入原厂固件直链'
        required: true

jobs:
  extract_all:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装依赖工具
        run: |
          sudo apt-get update
          sudo apt-get install -y binwalk dd u-boot-tools

      - name: 下载固件
        run: |
          curl -L --retry 3 "${{ github.event.inputs.firmware_url }}" -o full_dump.bin
          
      - name: 自动分析与全量切割
        run: |
          mkdir -p extracted_parts
          
          echo "=== 开始分析固件布局 ==="
          binwalk full_dump.bin
          
          # 1. 提取 Preloader (包含 DDR 配置)
          # 偏移 0x0, 大小 256KB
          dd if=full_dump.bin of=extracted_parts/01_Preloader.bin bs=1k count=256
          
          # 2. 提取 Factory (极其重要：含 MAC 地址和无线校准/无线基带)
          # 360T7 常见的 Factory 偏移在 0x40000，大小 256KB
          dd if=full_dump.bin of=extracted_parts/02_Factory.bin bs=1k skip=256 count=256
          
          # 3. 提取 FIP (U-Boot 所在分区)
          # 常见偏移在 0x100000 (1MB 处)，大小约 2MB
          dd if=full_dump.bin of=extracted_parts/03_FIP_Uboot.bin bs=1k skip=1024 count=2048
          
          # 4. 提取 Kernel (Linux 内核)
          # 使用 binwalk 自动定位并提取所有识别出的 LZMA/U-Boot 镜像
          binwalk -e --run-as=root full_dump.bin -C extracted_parts/bins
          
          # 5. 扫描备份分区信息
          strings full_dump.bin | grep -E "board|mac|model" > extracted_parts/device_info.txt || true

      - name: 上传所有提取分区
        uses: actions/upload-artifact@v4
        with:
          name: 360T7-Full-Extracted-Parts
          path: extracted_parts/

