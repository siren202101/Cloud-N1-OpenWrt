name: Build Hanwckf 360T7 U-Boot (108M Layout Fix)

on:
  workflow_dispatch:
    inputs:
      multi_layout:
        description: '布局选择 (0:原厂布局, 1:108M大分区布局)'
        required: true
        default: '1'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 检出 Hanwckf 源码
        uses: actions/checkout@v4
        with:
          repository: 'hanwckf/bl-mt798x'

      - name: 安装编译依赖
        run: |
          sudo apt update
          sudo apt install -y gcc-aarch64-linux-gnu build-essential flex bison libssl-dev device-tree-compiler qemu-user-static python3

      - name: 修复 360T7 ATF 配置缺失问题
        run: |
          # 进入 ATF 配置目录
          cd atf-2024* /configs || cd atf/configs || true
          # 如果没有 108m 的 ATF 配置，就用原版配置创建一个链接，骗过脚本
          if [ ! -f mt7981_360t7-108m_defconfig ]; then
             cp mt7981_360t7_defconfig mt7981_360t7-108m_defconfig
             echo "已为 ATF 补全 108m 配置文件"
          fi

      - name: 编译 360T7
        run: |
          # 根据输入决定 BOARD 名称
          if [ "${{ github.event.inputs.multi_layout }}" == "1" ]; then
             TARGET_BOARD=360t7-108m
          else
             TARGET_BOARD=360t7
          fi
          
          # 执行编译
          SOC=mt7981 BOARD=$TARGET_BOARD ./build.sh
          
          # 收集产物
          mkdir -p final_output
          cp output/mt7981_${TARGET_BOARD}-bl2.bin final_output/bl2-360t7.bin || cp output/*.bin final_output/
          cp output/mt7981_${TARGET_BOARD}-fip.bin final_output/fip-360t7.bin || true

      - name: 上传 108M 固件产物
        uses: actions/upload-artifact@v4
        with:
          name: 360T7-Uboot-Final
          path: final_output/

