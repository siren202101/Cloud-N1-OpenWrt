diff --git a/kernel-module/xt_RTPENGINE.c b/kernel-module/xt_RTPENGINE.c
index abc1234..def5678 100644
--- a/kernel-module/xt_RTPENGINE.c
+++ b/kernel-module/xt_RTPENGINE.c
@@ -15,6 +15,7 @@
 #include <net/tcp.h>
 #include <net/route.h>
 #include <net/ip6_route.h>
+#include <linux/version.h>
 
 /* ... other includes ... */
 
@@ -4000,7 +4000,15 @@ static int send_proxy_packet(struct sk_buff *skb, struct re_address *src, struct
 
 	switch (src->family) {
 	case AF_INET:
+		#if LINUX_VERSION_CODE >= KERNEL_VERSION(5,0,0)
+		struct flowi4 fl4 = {
+			.daddr = dst->u.ipv4,
+			.saddr = src->u.ipv4,
+			.flowi4_tos = tos,
+			.flowi4_oif = 0,
+		};
+		rt = ip_route_output_flow(net, &fl4, NULL);
+		#else
 		rt = ip_route_output(net, dst->u.ipv4, src->u.ipv4, tos, 0);
+		#endif
 		if (IS_ERR(rt))
 			goto out;
 		hh_len = (rt->dev->hard_header_len + 15) & ~15;
